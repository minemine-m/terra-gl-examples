<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tile Layer Example</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #111; }
        #map-container { width: 100%; height: 100%; }
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(30, 30, 30, 0.9);
            padding: 20px;
            border-radius: 8px;
            color: white;
            font-family: sans-serif;
            border: 1px solid #444;
            min-width: 200px;
            z-index: 100;
        }
        .panel-title { margin: 0 0 15px 0; font-size: 16px; font-weight: bold; }
        .layer-option { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; }
        .layer-option:hover { color: #4facfe; }
        .layer-option input { margin-right: 10px; cursor: pointer; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
                "@terra.gl/core": "https://unpkg.com/@terra.gl/core/dist/terra.gl.es.js"
            }
        }
    </script>
</head>
<body>
    <div id="map-container"></div>
    <div class="control-panel">
        <h3 class="panel-title">Base Layer</h3>
        <div id="layer-controls">
            <!-- Controls will be generated by JS -->
        </div>
    </div>

    <script type="module">
        import * as terra from '@terra.gl/core';

        let map = null;
        let currentLayer = null;

        const layers = {
            carto_dark: {
                name: 'Carto Dark',
                url: 'https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            },
            carto_light: {
                name: 'Carto Light',
                url: 'https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            },
            osm: {
                name: 'OpenStreetMap',
                url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; OpenStreetMap contributors'
            },
            arcgis: {
                name: 'ArcGIS Satellite',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Tiles &copy; Esri'
            }
        };

        function initMap() {
            // Initialize with Dark
            const config = layers.carto_dark;
            const source = new terra.WMTSSource({
                urlTemplate: config.url,
                minLevel: 0,
                maxLevel: 19,
                attribution: config.attribution
            });

            currentLayer = new terra.WMTSTileLayer("base-layer-init", {
                source: source,
                projection: terra.ProjectFactory.createFromID("3857", 0),
                layerName: "init-layer",
                style: "default",
                matrixSet: "EPSG:3857"
            });

            map = new terra.Map(document.getElementById('map-container'), {
                center: [116.405467, 39.907761, 2000],
                zoom: 12,
                viewer: {
                    antialias: true,
                    polarDeg: 70,
                    azimuthDeg: 0,
                    skybox: {
                        path: "/image/skyboxall/onemap/",
                        files: ["posx.jpg", "negx.jpg", "posy.jpg", "negy.jpg", "posz.jpg", "negz.jpg"],
                        defaultColor: '#121E3A'
                    }
                },
                basemap: {
                    Baselayers: [currentLayer],
                    minLevel: 2,
                    maxLevel: 19
                }
            });
        }

        function switchLayer(layerId) {
            if (!map) return;
            if (currentLayer) map.removeLayer(currentLayer.getId());

            const config = layers[layerId];
            const source = new terra.WMTSSource({
                urlTemplate: config.url,
                minLevel: 0,
                maxLevel: 19,
                attribution: config.attribution
            });

            const newLayer = new terra.WMTSTileLayer("base-layer-" + layerId, {
                source: source,
                projection: terra.ProjectFactory.createFromID("3857", 0),
                layerName: "layer-" + layerId,
                style: "default",
                matrixSet: "EPSG:3857"
            });

            map.addLayer(newLayer); 
            currentLayer = newLayer;
        }

        // Initialize UI
        const controlsContainer = document.getElementById('layer-controls');
        Object.keys(layers).forEach((key, index) => {
            const config = layers[key];
            const label = document.createElement('label');
            label.className = 'layer-option';
            
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'baselayer';
            input.value = key;
            input.checked = key === 'carto_dark';
            
            input.addEventListener('change', () => switchLayer(key));

            label.appendChild(input);
            label.appendChild(document.createTextNode(config.name));
            controlsContainer.appendChild(label);
        });

        initMap();

    </script>
</body>
</html>